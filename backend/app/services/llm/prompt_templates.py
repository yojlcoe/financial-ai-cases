"""
LLMプロンプトテンプレートの一元管理

全てのLLMプロンプトをこのファイルで一元管理することで、
複数箇所での重複を避け、保守性を向上させる。
"""

from typing import List


class PromptTemplates:
    """LLMプロンプトテンプレートを管理するクラス"""

    # カテゴリと業務領域の定義
    CATEGORIES = [
        "活用事例(顧客対応・サポート)",
        "活用事例(業務効率化・自動化)",
        "活用事例(リスク管理・コンプライアンス)",
        "活用事例(商品・サービス開発)",
        "活用事例(マーケティング・営業)",
        "活用事例(人事)",
        "活用事例(IT・システム・セキュリティ)",
        "活用事例(与信・審査)",
        "活用事例(法務・契約)",
        "活用事例(FX・トレーディング)",
        "セキュリティ・AIガバナンス",
        "組織・人材",
        "データ基盤・インフラ",
        "出資・協業",
        "IR・決算・戦略",
        "経済分析",
        "求人",
        "その他",
    ]

    BUSINESS_AREAS = [
        "リテールバンキング",
        "法人バンキング",
        "投資銀行",
        "資産運用",
        "FX・トレーディング",
        "決済・送金",
        "融資・ローン",
        "保険",
        "全社・共通",
        "その他",
    ]

    # === クラシファイア用プロンプト ===

    CLASSIFIER_SYSTEM_PROMPT = """あなたは金融業界のAI・DX事例を分類する専門家です。
与えられた記事を分析し、金融業界に関連する記事のみを適切に分類してください。

重要なルール:
1. **金融業界との関連性を厳格に判定すること**
   - 銀行、証券、保険、資産運用、決済、融資、投資など金融業界に直接関連する記事のみを対象とする
   - 金融機関が主体となっている、または金融サービスに直接関わる内容であること

2. **不適切な記事の判定基準（優先度順）**
   以下に該当する場合は is_inappropriate: true とすること:

   a) **企業無関係（最重要）**
      - 対象企業名が記事本文に1回も出現しない
      - 対象企業への言及が脚注や参考程度のみ
      - 他の企業の事例のみで、対象企業の具体的な活動・発表がない
      - 業界全体の話題で、対象企業が第三者的・客観的にしか登場しない

   b) **AI/DX内容なし**
      - AI、機械学習、生成AI、LLM、自動化、デジタル化などの具体的技術への言及がない
      - 単なる「スマート」「デジタル」「IT」のみで、AI/DX技術の実装がない
      - 一般的なシステム更新やインフラ整備のみ

   c) **リスト・まとめ記事**
      - URLに「list」「ranking」「matome」「summary」が含まれる
      - 複数企業の事例を羅列しているだけ
      - 記事一覧ページ、ニュースサイトのトップページ

   d) **アクセス・信頼性の問題**
      - 有償会員限定、ペイウォール
      - Mediumなどの個人ブログで信頼性が不明
      - 404エラー、アクセス不可
      - 動画のみで文字コンテンツなし

   e) **重複・既知**
      - 明らかに同じ内容の記事（タイトルと内容で判断）

   f) **その他の不適切**
      - 金融業界と無関係な業界の話題（ゲーム、教育、製造、小売など）
      - 求人情報のみ（ただしAI人材の求人は対象）

3. **カテゴリ選択の基準**
   - 「活用事例(顧客対応・サポート)」: チャットボット、問い合わせ対応、顧客サポート自動化
   - 「活用事例(業務効率化・自動化)」: RPA、業務プロセス自動化、バックオフィス効率化
   - 「活用事例(リスク管理・コンプライアンス)」: 不正検知、マネーロンダリング対策、コンプライアンス
   - 「活用事例(商品・サービス開発)」: 新サービス開発、プロダクト改善
   - 「活用事例(マーケティング・営業)」: マーケティング自動化、営業支援、顧客分析
   - 「活用事例(人事)」: 人材管理、採用、育成、評価
   - 「活用事例(IT・システム・セキュリティ)」: システム開発、インフラ、セキュリティ対策
   - 「活用事例(与信・審査)」: 融資審査、信用評価、リスク分析
   - 「活用事例(法務・契約)」: 契約書レビュー、法務業務支援、コンプライアンスチェック
   - 「活用事例(FX・トレーディング)」: 為替取引、アルゴリズムトレーディング、市場予測、自動売買、取引戦略最適化
   - 「セキュリティ・AIガバナンス」: AIに関するセキュリティリスク、対策、ガバナンスが主題
   - 「組織・人材」: AI人材育成、組織体制、文化変革が主題
   - 「データ基盤・インフラ」: データプラットフォーム、MLOps、インフラ構築が主題
   - 「出資・協業」: 金融機関によるAI/テック企業への出資・買収・提携・協業
   - 「IR・決算・戦略」: 金融機関のAI戦略、決算発表、中期経営計画
   - 「経済分析」: AI/DXが経済・金融市場に与える影響の分析
   - 「求人」: 金融業界でのAI/DX人材の求人情報

4. **ビジネス領域の選択基準**
   - 複数領域に関わる場合は、最も中心的な領域を選択
   - 記事に明示的に書かれている領域を優先"""

    @classmethod
    def get_classifier_user_prompt_template(cls) -> str:
        """クラシファイア用のユーザープロンプトテンプレートを取得"""
        categories_str = "\n".join([f"- {c}" for c in cls.CATEGORIES])
        areas_str = "\n".join([f"- {a}" for a in cls.BUSINESS_AREAS])

        return f"""以下の記事を分析し、金融業界との関連性を判定した上で分類してください。

【対象企業】
{{企業名がここに入ります}}

【記事内容】
{{記事のタイトルと本文がここに入ります}}

【カテゴリ一覧】（1つ選択）
{categories_str}

【業務領域一覧】（1つ選択）
{areas_str}

以下のJSON形式で出力してください:
{{
    "is_inappropriate": false,  // 金融業界と無関係、または内容不明な記事の場合はtrue
    "category": "選択したカテゴリ",
    "business_area": "選択した業務領域",
    "tags": ["具体的なタスクタグ1", "タグ2", "タグ3"]
}}

判定基準:
1. is_inappropriateの判定（厳格に以下の順で確認）:

   ステップ1: 【対象企業の関連性チェック（最優先）】
   - 対象企業名が記事本文に明示的に登場するか？
   - 対象企業の具体的な活動・発表・取り組みが記事の主題か？
   - → NOなら is_inappropriate: true（理由: "対象企業への具体的な言及なし"）

   ステップ2: 【AI/DX関連性チェック】
   - AI、機械学習、生成AI、LLM、RPA、自動化、データ分析などの具体的技術が実装されているか？
   - → NOなら is_inappropriate: true（理由: "AI/DX技術の具体的な実装なし"）

   ステップ3: 【記事タイプチェック】
   - リスト記事、まとめ記事、一覧ページではないか？
   - → YESなら is_inappropriate: true（理由: "リスト・まとめ記事"）

   ステップ4: 【アクセス・品質チェック】
   - 記事本文が取得できているか？（タイトルのみではないか）
   - 有償サイトやアクセス制限はないか？
   - → 問題ありなら is_inappropriate: true（理由: "本文取得不可/アクセス制限"）

   すべてのステップをクリアした場合のみ is_inappropriate: false

2. tagsには記事の具体的な内容を表すキーワードを3-5個付けてください。
   例: AIエージェント, 生成AI, チャットボット, 自動化, OCR, 不正検知, データ分析, RAG, LLM, 機械学習, リスク管理, コンプライアンス, 顧客対応 など

3. is_inappropriate: trueの場合でも、可能な範囲でcategory, business_area, tagsを設定してください（後で人間が判断する際の参考情報として）

JSON以外の文章は出力しないでください。"""

    @classmethod
    def build_classifier_user_prompt(
        cls,
        text: str,
        company_name: str = ""
    ) -> str:
        """実際の記事内容を埋め込んだクラシファイア用プロンプトを生成

        Args:
            text: 記事のタイトル、要約、本文を結合したテキスト
            company_name: 対象企業名（オプション）

        Returns:
            実際に使用するユーザープロンプト
        """
        # テンプレートを取得してプレースホルダーを置き換え
        template = cls.get_classifier_user_prompt_template()

        # プレースホルダーを実際の値に置換
        prompt = template.replace(
            "【対象企業】\n{企業名がここに入ります}",
            f"【対象企業】\n{company_name}" if company_name else "【対象企業】\n（指定なし）"
        )
        prompt = prompt.replace(
            "【記事内容】\n{記事のタイトルと本文がここに入ります}",
            f"【記事内容】\n{text}"
        )

        return prompt

    # === サマライザー用プロンプト ===

    SUMMARIZER_SYSTEM_PROMPT = """あなたは金融業界のAI・DX事例を分析する専門家です。
与えられた記事を分析し、指定された形式で要約してください。

重要なルール:
- **必ず日本語で出力すること（記事が英語でも日本語に翻訳して要約すること）**
- 記事に書かれている事実のみを記載すること
- 想像や推測で情報を補わないこと
- 情報がない項目は「記載なし」と明記すること
- 嘘をつかないこと"""

    SUMMARIZER_USER_PROMPT_TEMPLATE = """以下の記事を分析し、**必ず日本語で**JSON形式で要約してください。
記事が英語の場合は、日本語に翻訳して要約してください。

【企業名】
{企業名がここに入ります}

【記事タイトル】
{記事タイトルがここに入ります}

【記事本文】
{記事本文がここに入ります}

以下のJSON形式で**日本語で**出力してください:
{{
    "summary": "記事の概要を3-5文で日本語で要約",
    "key_points": ["重要ポイント1（日本語）", "重要ポイント2（日本語）", "重要ポイント3（日本語）"],
    "outcomes": "導入効果や成果を日本語で記載（記載がなければ「記載なし」）",
    "technology": "使用されている技術や仕組みを日本語で記載（記載がなければ「記載なし」）"
}}

重要: すべてのフィールドの値を日本語で出力してください。
JSON以外の文章は出力しないでください。"""

    @classmethod
    def build_summarizer_user_prompt(
        cls,
        title: str,
        content: str,
        company_name: str
    ) -> str:
        """実際の記事内容を埋め込んだサマライザー用プロンプトを生成

        Args:
            title: 記事タイトル
            content: 記事本文（最大3000文字）
            company_name: 企業名

        Returns:
            実際に使用するユーザープロンプト
        """
        return f"""以下の記事を分析し、**必ず日本語で**JSON形式で要約してください。
記事が英語の場合は、日本語に翻訳して要約してください。

【企業名】
{company_name}

【記事タイトル】
{title}

【記事本文】
{content[:3000]}

以下のJSON形式で**日本語で**出力してください:
{{
    "summary": "記事の概要を3-5文で日本語で要約",
    "key_points": ["重要ポイント1（日本語）", "重要ポイント2（日本語）", "重要ポイント3（日本語）"],
    "outcomes": "導入効果や成果を日本語で記載（記載がなければ「記載なし」）",
    "technology": "使用されている技術や仕組みを日本語で記載（記載がなければ「記載なし」）"
}}

重要: すべてのフィールドの値を日本語で出力してください。
JSON以外の文章は出力しないでください。"""

    # === AI関連性判定用プロンプト ===

    AI_RELEVANCE_SYSTEM_PROMPT = """あなたは厳格なAI関連性判定の専門家です。
AI技術が記事の主題・中核である場合のみ、慎重にAI関連と判定してください。

重要: 単なる「AI」「スマート」「インテリジェント」といった曖昧な単語だけでは不十分です。
具体的なAI技術の実装・活用が明記されている必要があります。"""

    AI_RELEVANCE_CONTENT_PROMPT_TEMPLATE = """JSONのみで回答してください: {{"ai_related": true|false, "reason": "簡潔な理由"}}.

この記事がAI（人工知能）の実装・活用・開発について**具体的かつ詳細に**述べているかを判定してください。

【TRUE判定基準（以下のいずれかが記事の主題である場合のみ）】

1. 生成AI技術の実装・活用:
   - ChatGPT、Claude、GPT-3/4/o1、LLM、大規模言語モデル
   - Gemini、Copilot、Bard、Llama、Anthropic
   - RAG（Retrieval-Augmented Generation）、プロンプトエンジニアリング
   - 文章生成、コード生成、画像生成（DALL-E、Stable Diffusion、Midjourney）

2. 機械学習・深層学習の実装:
   - ニューラルネットワーク、CNN、RNN、Transformer
   - 教師あり学習、教師なし学習、強化学習
   - モデル訓練、AI推論、MLOps
   - TensorFlow、PyTorch、scikit-learn等の具体的実装

3. AI主導の自動化・意思決定:
   - AIエージェント、AIアシスタント、対話型AI
   - AI予測モデル、異常検知AI、レコメンデーションAI
   - AIによる自動分類、自動判定、自動応答

4. 具体的なAI活用領域:
   - 画像認識・物体検出・顔認識（コンピュータビジョン）
   - 自然言語処理（NLP）、感情分析、テキストマイニング
   - 音声認識・音声合成（Speech AI）
   - AIチャットボット（単純なルールベースではなくAI駆動のもの）
   - 不正検知AI、リスク予測AI

【FALSE判定基準（以下の場合は必ずFALSE）】

1. DX・デジタル化のみ:
   - 「DX推進」「デジタル化」「デジタルトランスフォーメーション」のみでAI技術の具体的記載なし
   - システムのクラウド移行、ペーパーレス化、デジタルワークフロー

2. 一般的なIT技術:
   - クラウドコンピューティング（AWS、Azure、GCP）でAI要素なし
   - データベース、API、マイクロサービス
   - Web/モバイルアプリ開発（AI機能なし）

3. AI要素のない自動化:
   - ルールベースのRPA（AI/機械学習を使わない単純な業務自動化）
   - マクロ、スクリプト、バッチ処理
   - ワークフロー自動化ツール（AI機能なし）

4. 曖昧な「AI」言及:
   - 「AI時代」「AI活用を検討」など抽象的・将来的な言及のみ
   - 「スマート〇〇」「インテリジェント〇〇」で技術詳細なし
   - AI企業・AI市場の一般的な話題で具体的技術がない

5. その他:
   - データ分析・BIツール（AI/ML要素なし）
   - IoT、センサー、エッジコンピューティング（AI処理なし）
   - サイバーセキュリティ（AIベースでない）
   - ブロックチェーン、仮想通貨、NFT

【判定方法】
1. 記事中に具体的なAI技術名・製品名が出現するか？
2. AI実装・導入の具体的な内容が記載されているか？
3. AIが記事の中心的なテーマか、それとも脇役・参考程度か？

タイトル: {title}

本文プレビュー:
{content_preview}
"""

    @classmethod
    def build_ai_relevance_content_prompt(cls, title: str, content_preview: str) -> str:
        """記事本文からAI関連性を判定するプロンプトを生成

        Args:
            title: 記事タイトル
            content_preview: 記事本文のプレビュー（最初の1000文字程度）

        Returns:
            実際に使用するプロンプト
        """
        return cls.AI_RELEVANCE_CONTENT_PROMPT_TEMPLATE.format(
            title=title,
            content_preview=content_preview
        )

    AI_RELEVANCE_TEXT_PROMPT_TEMPLATE = """JSONのみで回答してください: {{"ai_related": true|false}}.

タイトルとスニペットから、この記事がAI（人工知能）の実装・活用について**具体的に**述べているかを判定してください。

【TRUE判定基準（いずれかが明示されている場合のみ）】
- 生成AI技術: ChatGPT、Claude、GPT、LLM、大規模言語モデル、Gemini、Copilot
- 機械学習実装: ニューラルネットワーク、深層学習、AI推論、モデル訓練
- AI主導システム: AIエージェント、AIアシスタント、対話型AI、AI予測
- 具体的AI活用: 画像認識、自然言語処理、音声認識、AIチャットボット、不正検知AI

【FALSE判定基準（以下は必ずFALSE）】
- 「DX」「デジタル化」のみで具体的AI技術の記載なし
- 一般的なIT/クラウド/SaaS（AI要素なし）
- ルールベースのRPA、業務自動化（AI/ML要素なし）
- 「スマート」「インテリジェント」のみで技術詳細なし
- 「AI時代」「AI検討」など抽象的・将来的な言及のみ

タイトル: {title}
スニペット: {snippet}
"""

    @classmethod
    def build_ai_relevance_text_prompt(cls, title: str, snippet: str) -> str:
        """タイトル+スニペットからAI関連性を判定するプロンプトを生成（フォールバック用）

        Args:
            title: 記事タイトル
            snippet: 記事のスニペット

        Returns:
            実際に使用するプロンプト
        """
        return cls.AI_RELEVANCE_TEXT_PROMPT_TEMPLATE.format(
            title=title,
            snippet=snippet
        )

    # 設定
    CLASSIFIER_TEMPERATURE = 0.2
    SUMMARIZER_TEMPERATURE = 0.2
    AI_RELEVANCE_TEMPERATURE = 0.1  # 一貫性を保つため低温度