"""
LLMプロンプトテンプレートの一元管理

全てのLLMプロンプトをこのファイルで一元管理することで、
複数箇所での重複を避け、保守性を向上させる。
"""

from typing import List


class PromptTemplates:
    """LLMプロンプトテンプレートを管理するクラス"""

    # カテゴリと業務領域の定義
    CATEGORIES = [
        "活用事例(顧客対応・サポート)",
        "活用事例(業務効率化・自動化)",
        "活用事例(リスク管理・コンプライアンス)",
        "活用事例(商品・サービス開発)",
        "活用事例(マーケティング・営業)",
        "活用事例(人事)",
        "活用事例(IT・システム・セキュリティ)",
        "活用事例(与信・審査)",
        "活用事例(法務・契約)",
        "活用事例(FX・トレーディング)",
        "セキュリティ・AIガバナンス",
        "組織・人材",
        "データ基盤・インフラ",
        "出資・協業",
        "IR・決算・戦略",
        "経済分析",
        "求人",
        "その他",
    ]

    BUSINESS_AREAS = [
        "リテールバンキング",
        "法人バンキング",
        "投資銀行",
        "資産運用",
        "FX・トレーディング",
        "決済・送金",
        "融資・ローン",
        "保険",
        "全社・共通",
        "その他",
    ]

    # === クラシファイア用プロンプト ===

    CLASSIFIER_SYSTEM_PROMPT = """あなたは金融業界のAI・DX事例を分類する専門家です。
与えられた記事を分析し、金融業界に関連する記事のみを適切に分類してください。

重要なルール:
1. **金融業界との関連性を厳格に判定すること**
   - 銀行、証券、保険、資産運用、決済、融資、投資など金融業界に直接関連する記事のみを対象とする
   - 金融機関が主体となっている、または金融サービスに直接関わる内容であること

2. **不適切な記事の判定基準**
   以下に該当する場合は is_inappropriate: true とすること:
   - 金融業界と無関係な業界の話題（ゲーム、教育、製造、小売など）
   - 対象企業と無関係な記事（他の企業の話題のみで、対象企業への言及がない）
   - 単なる金融ニュースサイトのトップページや一覧ページのURL
   - AIやDXに関する言及がほぼない一般的な金融ニュース
   - プレスリリースでも金融業界に関連しない企業の資金調達情報のみの記事

3. **カテゴリ選択の基準**
   - 「活用事例(顧客対応・サポート)」: チャットボット、問い合わせ対応、顧客サポート自動化
   - 「活用事例(業務効率化・自動化)」: RPA、業務プロセス自動化、バックオフィス効率化
   - 「活用事例(リスク管理・コンプライアンス)」: 不正検知、マネーロンダリング対策、コンプライアンス
   - 「活用事例(商品・サービス開発)」: 新サービス開発、プロダクト改善
   - 「活用事例(マーケティング・営業)」: マーケティング自動化、営業支援、顧客分析
   - 「活用事例(人事)」: 人材管理、採用、育成、評価
   - 「活用事例(IT・システム・セキュリティ)」: システム開発、インフラ、セキュリティ対策
   - 「活用事例(与信・審査)」: 融資審査、信用評価、リスク分析
   - 「活用事例(法務・契約)」: 契約書レビュー、法務業務支援、コンプライアンスチェック
   - 「活用事例(FX・トレーディング)」: 為替取引、アルゴリズムトレーディング、市場予測、自動売買、取引戦略最適化
   - 「セキュリティ・AIガバナンス」: AIに関するセキュリティリスク、対策、ガバナンスが主題
   - 「組織・人材」: AI人材育成、組織体制、文化変革が主題
   - 「データ基盤・インフラ」: データプラットフォーム、MLOps、インフラ構築が主題
   - 「出資・協業」: 金融機関によるAI/テック企業への出資・買収・提携・協業
   - 「IR・決算・戦略」: 金融機関のAI戦略、決算発表、中期経営計画
   - 「経済分析」: AI/DXが経済・金融市場に与える影響の分析
   - 「求人」: 金融業界でのAI/DX人材の求人情報

4. **ビジネス領域の選択基準**
   - 複数領域に関わる場合は、最も中心的な領域を選択
   - 記事に明示的に書かれている領域を優先"""

    @classmethod
    def get_classifier_user_prompt_template(cls) -> str:
        """クラシファイア用のユーザープロンプトテンプレートを取得"""
        categories_str = "\n".join([f"- {c}" for c in cls.CATEGORIES])
        areas_str = "\n".join([f"- {a}" for a in cls.BUSINESS_AREAS])

        return f"""以下の記事を分析し、金融業界との関連性を判定した上で分類してください。

【対象企業】
{{企業名がここに入ります}}

【記事内容】
{{記事のタイトルと本文がここに入ります}}

【カテゴリ一覧】（1つ選択）
{categories_str}

【業務領域一覧】（1つ選択）
{areas_str}

以下のJSON形式で出力してください:
{{
    "is_inappropriate": false,  // 金融業界と無関係、または内容不明な記事の場合はtrue
    "category": "選択したカテゴリ",
    "business_area": "選択した業務領域",
    "tags": ["具体的なタスクタグ1", "タグ2", "タグ3"]
}}

判定基準:
1. is_inappropriateの判定:
   - 金融業界（銀行・証券・保険・資産運用・決済など）と直接関係ない場合はtrue
   - 【重要】対象企業が指定されている場合、その企業に関する内容でない場合はtrue
     （他の企業の話題のみで、対象企業への言及が全くない場合）
   - タイトルだけで本文が取得できていない、または内容が不明な場合はtrue
   - 金融ニュースサイトのトップページや一覧ページのみの場合はtrue
   - 金融業界に関係があり、AI/DXに関する具体的な内容がある場合のみfalse

2. tagsには記事の具体的な内容を表すキーワードを3-5個付けてください。
   例: AIエージェント, 生成AI, チャットボット, 自動化, OCR, 不正検知, データ分析, RAG, LLM, 機械学習, リスク管理, コンプライアンス, 顧客対応 など

3. is_inappropriate: trueの場合でも、可能な範囲でcategory, business_area, tagsを設定してください（後で人間が判断する際の参考情報として）

JSON以外の文章は出力しないでください。"""

    @classmethod
    def build_classifier_user_prompt(
        cls,
        text: str,
        company_name: str = ""
    ) -> str:
        """実際の記事内容を埋め込んだクラシファイア用プロンプトを生成

        Args:
            text: 記事のタイトル、要約、本文を結合したテキスト
            company_name: 対象企業名（オプション）

        Returns:
            実際に使用するユーザープロンプト
        """
        # テンプレートを取得してプレースホルダーを置き換え
        template = cls.get_classifier_user_prompt_template()

        # プレースホルダーを実際の値に置換
        prompt = template.replace(
            "【対象企業】\n{企業名がここに入ります}",
            f"【対象企業】\n{company_name}" if company_name else "【対象企業】\n（指定なし）"
        )
        prompt = prompt.replace(
            "【記事内容】\n{記事のタイトルと本文がここに入ります}",
            f"【記事内容】\n{text}"
        )

        return prompt

    # === サマライザー用プロンプト ===

    SUMMARIZER_SYSTEM_PROMPT = """あなたは金融業界のAI・DX事例を分析する専門家です。
与えられた記事を分析し、指定された形式で要約してください。

重要なルール:
- **必ず日本語で出力すること（記事が英語でも日本語に翻訳して要約すること）**
- 記事に書かれている事実のみを記載すること
- 想像や推測で情報を補わないこと
- 情報がない項目は「記載なし」と明記すること
- 嘘をつかないこと"""

    SUMMARIZER_USER_PROMPT_TEMPLATE = """以下の記事を分析し、**必ず日本語で**JSON形式で要約してください。
記事が英語の場合は、日本語に翻訳して要約してください。

【企業名】
{企業名がここに入ります}

【記事タイトル】
{記事タイトルがここに入ります}

【記事本文】
{記事本文がここに入ります}

以下のJSON形式で**日本語で**出力してください:
{{
    "summary": "記事の概要を3-5文で日本語で要約",
    "key_points": ["重要ポイント1（日本語）", "重要ポイント2（日本語）", "重要ポイント3（日本語）"],
    "outcomes": "導入効果や成果を日本語で記載（記載がなければ「記載なし」）",
    "technology": "使用されている技術や仕組みを日本語で記載（記載がなければ「記載なし」）"
}}

重要: すべてのフィールドの値を日本語で出力してください。
JSON以外の文章は出力しないでください。"""

    @classmethod
    def build_summarizer_user_prompt(
        cls,
        title: str,
        content: str,
        company_name: str
    ) -> str:
        """実際の記事内容を埋め込んだサマライザー用プロンプトを生成

        Args:
            title: 記事タイトル
            content: 記事本文（最大3000文字）
            company_name: 企業名

        Returns:
            実際に使用するユーザープロンプト
        """
        return f"""以下の記事を分析し、**必ず日本語で**JSON形式で要約してください。
記事が英語の場合は、日本語に翻訳して要約してください。

【企業名】
{company_name}

【記事タイトル】
{title}

【記事本文】
{content[:3000]}

以下のJSON形式で**日本語で**出力してください:
{{
    "summary": "記事の概要を3-5文で日本語で要約",
    "key_points": ["重要ポイント1（日本語）", "重要ポイント2（日本語）", "重要ポイント3（日本語）"],
    "outcomes": "導入効果や成果を日本語で記載（記載がなければ「記載なし」）",
    "technology": "使用されている技術や仕組みを日本語で記載（記載がなければ「記載なし」）"
}}

重要: すべてのフィールドの値を日本語で出力してください。
JSON以外の文章は出力しないでください。"""

    # === AI関連性判定用プロンプト ===

    AI_RELEVANCE_SYSTEM_PROMPT = """あなたは厳格なAI関連性判定の専門家です。AIが記事の主題である場合のみ、慎重にAI関連と判定してください。"""

    AI_RELEVANCE_CONTENT_PROMPT_TEMPLATE = """JSONのみで回答してください: {{"ai_related": true|false, "reason": "簡潔な理由"}}.

この記事がAI（人工知能）の実装・活用・開発について具体的に述べているかを判定してください。

【厳格な基準 - 以下の具体的なAI技術への言及がある場合のみTRUE】
- 生成AI技術: ChatGPT、Claude、GPT-3/4、LLM、大規模言語モデル、Gemini、Copilot、Bard
- AI/機械学習の実装: ニューラルネットワーク、深層学習モデル、AI学習、AI推論
- AI活用の自動化: AIエージェント、AIアシスタント、AI主導の意思決定
- 具体的なAIツール/プラットフォーム: TensorFlow、PyTorch、Hugging Face、OpenAI API、Azure AI、AWS AI
- 具体的なAI活用事例: 画像認識、自然言語処理、音声認識、AIチャットボット、生成AI活用

【FALSEと判定すべきケース】
- 「DX（デジタルトランスフォーメーション）」や「デジタル化」のみでAI技術の具体的言及がない
- クラウドコンピューティング、SaaS、PaaS、IaaSでAI要素がない
- 一般的なITシステム、データベース、インフラ
- RPA（ロボティック・プロセス・オートメーション）でAI/ML要素がない業務自動化
- AI/MLを使わないデータ分析、BIツール
- AI機能を持たないモバイルアプリ、Webサービス
- AIを使わないIoT、センサー、エッジコンピューティング
- AIベースでないサイバーセキュリティ
- AI技術の詳細がない一般的な「スマート」「インテリジェント」システム

タイトル: {title}

本文プレビュー:
{content_preview}
"""

    @classmethod
    def build_ai_relevance_content_prompt(cls, title: str, content_preview: str) -> str:
        """記事本文からAI関連性を判定するプロンプトを生成

        Args:
            title: 記事タイトル
            content_preview: 記事本文のプレビュー（最初の1000文字程度）

        Returns:
            実際に使用するプロンプト
        """
        return cls.AI_RELEVANCE_CONTENT_PROMPT_TEMPLATE.format(
            title=title,
            content_preview=content_preview
        )

    AI_RELEVANCE_TEXT_PROMPT_TEMPLATE = """JSONのみで回答してください: {{"ai_related": true|false}}.

タイトルとスニペットから、この記事がAI（人工知能）に関連するかを判定してください。

判定基準:
- 生成AI（ChatGPT、GPT、LLM等）の活用が明記されている
- 機械学習、深層学習、ニューラルネットワークの実装が含まれる
- AI自動化、AIエージェント、AIアシスタントの導入が述べられている

除外すべきケース:
- DXやデジタル化のみでAIへの具体的な言及がない
- 一般的なIT、クラウド、SaaSサービス
- AI要素のないRPA、自動化

タイトル: {title}
スニペット: {snippet}
"""

    @classmethod
    def build_ai_relevance_text_prompt(cls, title: str, snippet: str) -> str:
        """タイトル+スニペットからAI関連性を判定するプロンプトを生成（フォールバック用）

        Args:
            title: 記事タイトル
            snippet: 記事のスニペット

        Returns:
            実際に使用するプロンプト
        """
        return cls.AI_RELEVANCE_TEXT_PROMPT_TEMPLATE.format(
            title=title,
            snippet=snippet
        )

    # 設定
    CLASSIFIER_TEMPERATURE = 0.2
    SUMMARIZER_TEMPERATURE = 0.2
    AI_RELEVANCE_TEMPERATURE = 0.1  # 一貫性を保つため低温度